[thermistor EPCOS_B57540G0104F000]
#https://media.digikey.com/pdf/Data%20Sheets/Epcos%20PDFs/B57540.pdf
#beta: 4066
#temperature1: 25
#resistance1: 100000
temperature1: 115.0 
resistance1: 4115
temperature2: 90.0 
resistance2: 8674 
temperature3: 60.0
resistance3: 24161

[stepper_x]
step_pin: PB13
dir_pin: !PB12
enable_pin: !PB14
full_steps_per_rotation: 400
rotation_distance: 40
endstop_pin: ^PC0
position_endstop: 250
position_min: 0
position_max: 250
homing_speed: 70
homing_positive_dir: true
microsteps: 64

[tmc2209 stepper_x]
uart_pin: PC11
tx_pin: PC10
uart_address: 0
run_current: 0.5
hold_current: 0.3
interpolate: True
stealthchop_threshold: 250

[stepper_y]
step_pin: PB10
dir_pin: PB2
enable_pin: !PB11
rotation_distance: 40
full_steps_per_rotation: 200 
endstop_pin: ^PC1
position_endstop: 250
position_min: 0
position_max: 250
homing_speed: 70
homing_positive_dir: true
microsteps: 64

[tmc2209 stepper_y]
uart_pin: PC11
tx_pin: PC10
uart_address: 2
run_current: 0.5
hold_current: 0.3
interpolate: True
stealthchop_threshold: 250

[stepper_z]
step_pin: PB0
dir_pin: !PC5
enable_pin: !PB1
full_steps_per_rotation: 400
rotation_distance: 40
endstop_pin: ^PC2
#position_endstop = 1.162
position_max: 250
homing_speed: 20
position_min: -3.0
microsteps: 64

[tmc2209 stepper_z]
uart_pin: PC11
tx_pin: PC10
uart_address: 1
run_current: 0.5
hold_current: 0.3
interpolate: True
stealthchop_threshold: 250

[endstop_phase]

#[endstop_phase stepper_z]
#endstop_align_zero: True
#trigger_phase = 61/64 

[firmware_retraction]

[display_status]

[homing_override]
axes: z
set_position_z: 0
gcode:
    G90
    G0 Z5 F500
    G28 X0 Y0
    G0 X125 Y100 F9000
    G28 Z0
    endstop_phase_calibrate
    G0 Z5 F500
    endstop_phase_calibrate

[bed_mesh]
horizontal_move_z: 5
mesh_min: 25,35.0
mesh_max: 225.0,220
#probe_count: 3,3
#relative_reference_index: 4
#probe_count: 5,5
#relative_reference_index: 12
#probe_count: 7,7
#relative_reference_index: 24
#probe_count: 9,9
#relative_reference_index: 40
#probe_count: 13,13
#relative_reference_index: 84
probe_count: 15,15
relative_reference_index: 112
algorithm: bicubic
speed: 80
fade_start: 1
fade_end: 10
fade_target: 0

[probe]
pin: ^PC13
x_offset: 0.0
y_offset: 25.0
#z_offset = 1.662
z_offset = 1.525
speed: 2
lift_speed: 2
samples: 40
sample_retract_dist: 3
samples_result: median
samples_tolerance_retries: 10


#- [bed_mesh]
#- horizontal_move_z: 5
#- mesh_min: 25,35.0
#- mesh_max: 225.0,220
#- probe_count: 7,7
#- algorithm: bicubic
#- speed: 40
#- fade_start: 1
#- fade_end: 10
#- fade_target: 0
#- 
#- [probe]
#- pin: ^PC2
#- x_offset: 0.0
#- y_offset: 25.0
#- #z_offset: 1.85
#- speed: 2
#- lift_speed: 2
#- samples: 15
#- samples_result: average
#- #sample_retract_dist: 4.0
#- samples_tolerance: 0.03
#- samples_tolerance_retries: 10


[extruder]
max_extrude_only_distance: 100.0
step_pin: PB3
dir_pin: PB4
enable_pin: !PD2
step_distance: 0.00120
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PC8
pressure_advance: 0.055
pressure_advance_smooth_time: 0.040
#sensor_type: ATC Semitec 104GT-2
#sensor_type: EPCOS 100K B57560G104F
#sensor_type: NTC 100K beta 3950
sensor_type: SliceEngineering 450
sensor_pin: PA0
#control = pid
#pid_kp = 18.973
#pid_ki = 0.771
#pid_kd = 116.683
min_temp: 0
max_temp: 275

[tmc2209 extruder]
uart_pin: PC11
tx_pin: PC10
uart_address: 3
microsteps: 32
run_current: 0.7
hold_current: 0.3
interpolate: True

[controller_fan my_controller_fan]
pin: PA1
max_power: 1.00
kick_start_time: 0.200
heater: heater_bed

[idle_timeout]
#gcode:
#   A list of G-Code commands to execute on an idle timeout. See
#   docs/Command_Templates.md for G-Code format. The default is to run
#   "TURN_OFF_HEATERS" and "M84".
timeout: 1200
#   Idle time (in seconds) to wait before running the above G-Code
#   commands. The default is 600 seconds.

[screws_tilt_adjust]
screw1: 110, 110
screw1_name: Middle
screw2: 10, 110
screw2_name: Middle_Left
screw3: 5,5
screw3_name: Front_Left
screw4: 110,5
screw4_name: Front_Middle
screw5: 225,5
screw5_name: Front_Right
screw6: 225,110
screw6_name: Middle_Right
screw7: 225,215
screw7_name: Back_Right
screw8: 110,215
screw8_name: Back_Middle
screw9:5,215
screw9_name: Back_Left
speed: 100
horizontal_move_z: 5
screw_thread: CCW-M3

[heater_bed]
heater_pin: PC9
#sensor_type: ATC Semitec 104GT-2
#sensor_type: EPCOS 100K B57560G104F
sensor_type: EPCOS_B57540G0104F000
sensor_pin: PC3
#control = pid
#pid_kp = 60.695
#pid_ki = 1.073
#pid_kd = 858.069
min_temp: 0
max_temp: 130

[verify_heater heater_bed]
#max_error: 120
#   The maximum "cumulative temperature error" before raising an
#   error. Smaller values result in stricter checking and larger
#   values allow for more time before an error is reported.
#   Specifically, the temperature is inspected once a second and if it
#   is close to the target temperature then an internal "error
#   counter" is reset; otherwise, if the temperature is below the
#   target range then the counter is increased by the amount the
#   reported temperature differs from that range. Should the counter
#   exceed this "max_error" then an error is raised. The default is
#   120.
check_gain_time: 180
#   This controls heater verification during initial heating. Smaller
#   values result in stricter checking and larger values allow for
#   more time before an error is reported. Specifically, during
#   initial heating, as long as the heater increases in temperature
#   within this time frame (specified in seconds) then the internal
#   "error counter" is reset. The default is 20 seconds for extruders
#   and 60 seconds for heater_bed.
#hysteresis: 5
#   The maximum temperature difference (in Celsius) to a target
#   temperature that is considered in range of the target. This
#   controls the max_error range check. It is rare to customize this
#   value. The default is 5.
heating_gain: 1
#   The minimum temperature (in Celsius) that the heater must increase
#   by during the check_gain_time check. It is rare to customize this
#   value. The default is 2.

[fan]
pin: PC7

# thermally controlled hotend fan
[heater_fan my_nozzle_fan]
pin: PC6
max_power: 1.0
kick_start_time: 0.100
heater: extruder
heater_temp: 50.0
fan_speed: 1.0

[mcu]
#serial: /dev/serial/by-id/usb-Klipper_stm32f103xe_35FFD8054246303211710657-if00
#serial: /dev/serial/by-id/usb-Klipper_stm32f103xe_31FFDA054246303109850557-if00
#serial: /dev/serial/by-id/usb-Klipper_stm32f103xe_31FFDA054246303109850557-if00
serial: /dev/serial/by-id/usb-Klipper_stm32f103xe_34FFD6054254323812861757-if00

[mcu host]
serial: /tmp/klipper_host_mcu

[temperature_sensor RaspberryPi]
sensor_type: rpi_temperature
#gcode_id: A

[temperature_sensor PSU]
sensor_type: DS18B20
sensor_mcu: host
serial_no: 28-01131f83439a 
min_temp: -15
max_temp: 100

[temperature_sensor Exhaust]
sensor_type: DS18B20
sensor_mcu: host
serial_no:  28-01131bd1c3ef 
min_temp: -15
max_temp: 100

[temperature_sensor Chamber]
sensor_type: DS18B20
sensor_mcu: host
serial_no:  28-021313abbcaa 
min_temp: -15
max_temp: 100

[adxl345]
cs_pin: host:None

[resonance_tester]
accel_chip: adxl345
probe_points: 125,125,30
#max_smoothing:
#min_freq: 5
#max_freq: 120
#accel_per_hz: 75
#hz_per_sec: 1

[input_shaper]
shaper_freq_x: 60
shaper_type_x: zv
shaper_freq_y: 42.2
shaper_type_y: 2hump_ei

[printer]
kinematics: corexz
max_velocity: 200
max_accel: 3000
max_z_velocity: 50
max_z_accel: 500
square_corner_velocity: 4.0

[static_digital_output usb_pullup_enable]
pins: !PA14

[output_pin LIGHTS]
pin: PA8
value: 0
shutdown_value: 0

[virtual_sdcard]
path: /home/pi/sdcard

[gcode_macro lights_on]
gcode:
    SET_PIN PIN=LIGHTS VALUE=1.0

[gcode_macro lights_off]
gcode:
    SET_PIN PIN=LIGHTS VALUE=0.0

[pause_resume]

[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
default_parameter_X: 230
default_parameter_Y: 230
default_parameter_Z: 10
gcode:
    M104 S0
    M140 S0
    M141 S0
    M106 S0
    TURN_OFF_HEATERS
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    BASE_CANCEL_PRINT

[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
default_parameter_X: 230
default_parameter_Y: 230
default_parameter_Z: 10
gcode:
    SAVE_GCODE_STATE NAME=PAUSE_state
    BASE_PAUSE
    G91
    G1 E-1.7 F2100
    G1 Z{Z}
    G90
    G1 X{X} Y{Y} F6000
    G91

[gcode_macro RESUME]
rename_existing: BASE_RESUME
gcode:
    G91
    G1 E1.7 F2100
    G91
    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
    BASE_RESUME

[gcode_macro DISABLE_MOTORS]
gcode:
    M18

    	
[gcode_macro PRINT_START]
#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
default_parameter_BED_TEMP: 110
default_parameter_EXTRUDER_TEMP: 240
gcode:
    M117 Heating...
    lights_on;
    M140 S{BED_TEMP}                         ; set bed final temp
    M104 S{EXTRUDER_TEMP}                         ; set extruder final temp
    M190 S{BED_TEMP}                         ; wait for bed final temp
    M109 S{EXTRUDER_TEMP}                         ; wait for extruder final temp
    M117 Heating... Done
    M900
    G21 ; set units to millimeters
    G90 ; use absolute coordinates
    M83 ; use relative distances for extrusion
    G32                            ; home all axes
    G1 Z20 F3000                   ; move nozzle away from bed

[gcode_macro PURGE_LINE]    
gcode:
# Print Purge line
    g90;
    M83;
    G92 E0;                         
    G1 Z5 X10 Y10 F10000;
    G1 Z0.2 X50 E2 F500;             
    G1 X100 E2 F500;
    G91                
    G1 Y+0.1 F500;
    g90
    G1 X10 E2 F500;                
    G1 X120 Z5.0 F9000;               
    G92 E0;

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 23.965
#*# pid_ki = 0.940
#*# pid_kd = 152.778
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 54.446
#*# pid_ki = 0.733
#*# pid_kd = 1010.663
#*#
#*# [bed_mesh 3x3]
#*# version = 1
#*# points =
#*# 	0.006250, -0.012500, 0.062500
#*# 	0.056250, 0.000000, 0.087500
#*# 	0.018750, -0.025000, 0.065625
#*# tension = 0.2
#*# bicubic_tension = 0.01
#*# min_x = 25.0
#*# algo = bicubic
#*# y_count = 3
#*# mesh_y_pps = 2
#*# min_y = 35.0
#*# x_count = 3
#*# max_y = 220.0
#*# mesh_x_pps = 2
#*# max_x = 225.0
#*#
#*# [bed_mesh 13X13]
#*# version = 1
#*# points =
#*# 	0.021875, -0.075000, -0.034375, -0.084375, -0.050000, 0.028125, -0.006250, -0.015625, -0.015625, -0.062500, -0.046875, -0.087500, -0.059375
#*# 	-0.003125, 0.025000, 0.009375, -0.015625, 0.006250, 0.046875, 0.012500, -0.028125, -0.028125, -0.043750, -0.015625, -0.050000, -0.040625
#*# 	0.053125, 0.025000, 0.040625, 0.053125, 0.006250, 0.015625, 0.012500, 0.046875, -0.009375, -0.018750, -0.034375, -0.093750, -0.084375
#*# 	0.065625, 0.062500, 0.009375, 0.009375, 0.018750, 0.003125, -0.037500, -0.034375, -0.040625, -0.056250, -0.034375, -0.081250, -0.059375
#*# 	0.040625, 0.050000, 0.053125, 0.053125, 0.031250, 0.009375, 0.025000, -0.009375, -0.003125, -0.031250, -0.028125, -0.075000, -0.084375
#*# 	-0.015625, 0.012500, 0.046875, 0.065625, -0.006250, 0.015625, -0.006250, -0.028125, -0.021875, -0.037500, -0.034375, -0.062500, -0.071875
#*# 	-0.009375, 0.025000, 0.009375, -0.046875, -0.018750, 0.046875, 0.000000, -0.015625, -0.009375, -0.068750, -0.003125, 0.006250, -0.028125
#*# 	0.015625, 0.006250, -0.028125, -0.015625, -0.006250, -0.021875, -0.018750, -0.040625, -0.015625, -0.062500, -0.015625, -0.018750, -0.046875
#*# 	0.065625, 0.006250, -0.034375, 0.021875, 0.006250, 0.003125, -0.037500, -0.028125, -0.021875, -0.025000, -0.009375, -0.050000, -0.053125
#*# 	0.065625, 0.062500, 0.021875, 0.015625, 0.018750, -0.015625, -0.018750, -0.040625, -0.040625, -0.056250, -0.015625, -0.075000, -0.059375
#*# 	0.003125, 0.000000, -0.015625, 0.015625, -0.025000, -0.021875, -0.025000, -0.021875, -0.053125, -0.081250, -0.040625, -0.056250, -0.015625
#*# 	-0.040625, -0.050000, -0.028125, 0.028125, 0.000000, -0.059375, -0.062500, -0.028125, -0.059375, -0.075000, -0.046875, -0.068750, -0.034375
#*# 	-0.034375, -0.025000, -0.053125, 0.015625, -0.031250, -0.059375, -0.062500, -0.034375, -0.021875, -0.037500, -0.053125, -0.062500, -0.028125
#*# tension = 0.2
#*# min_x = 25.0
#*# algo = bicubic
#*# y_count = 13
#*# mesh_y_pps = 2
#*# min_y = 35.0
#*# x_count = 13
#*# max_y = 219.92
#*# mesh_x_pps = 2
#*# max_x = 224.92
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.082031, -0.130469, -0.122656, -0.130469, -0.158594, -0.063281, -0.030469, -0.071094, -0.067187, -0.015625, -0.025000, 0.030469, 0.082813, -0.005469, -0.000781
#*# 	0.025781, 0.000781, -0.014844, -0.035156, -0.065625, -0.022656, -0.030469, 0.003125, 0.015625, 0.049219, 0.078906, 0.106250, 0.101563, -0.025000, 0.041406
#*# 	0.050781, 0.033594, 0.006250, -0.016406, -0.046094, -0.016406, -0.046875, -0.060937, -0.015625, 0.042969, 0.069531, 0.105469, 0.102344, 0.053125, 0.052344
#*# 	0.074219, 0.091406, 0.043750, 0.025000, -0.010156, -0.022656, -0.034375, 0.048438, 0.010938, 0.062500, 0.049219, 0.097656, 0.089063, 0.073438, 0.063281
#*# 	0.094531, 0.092969, 0.071875, 0.015625, -0.029687, -0.011719, -0.050000, -0.153125, -0.031250, 0.046875, 0.044531, 0.086719, 0.079688, 0.073438, 0.054688
#*# 	0.067188, 0.097656, 0.078125, 0.075781, -0.008594, 0.002344, 0.014844, -0.003125, 0.004688, 0.081250, 0.064844, 0.078906, 0.086719, 0.071875, 0.041406
#*# 	0.048438, 0.053906, 0.042969, 0.003906, -0.089844, -0.019531, 0.003906, -0.051562, 0.043750, 0.042188, 0.032031, 0.044531, 0.057813, 0.020313, 0.029688
#*# 	0.033594, 0.018750, 0.003125, 0.004688, -0.096094, -0.023437, 0.018750, 0.000000, 0.064063, 0.032031, 0.007031, -0.003125, 0.013281, 0.032813, 0.021094
#*# 	0.032031, 0.017969, 0.007031, -0.056250, -0.157031, -0.023437, -0.011719, -0.028125, 0.014844, -0.005469, -0.066406, -0.046094, 0.031250, 0.031250, 0.030469
#*# 	0.009375, -0.011719, -0.003125, -0.024219, -0.100000, -0.000781, -0.039844, -0.025000, -0.000000, -0.000781, -0.038281, -0.010938, 0.063281, 0.048437, 0.055469
#*# 	0.025781, 0.007031, 0.004687, -0.050000, -0.107031, -0.035156, -0.058594, -0.003906, -0.018750, -0.023438, -0.046094, 0.000781, 0.060937, 0.039844, 0.049219
#*# 	-0.020313, -0.008594, 0.003125, -0.045313, -0.077344, -0.055469, -0.040625, -0.175000, -0.070313, -0.011719, -0.021094, 0.028906, 0.070312, 0.049219, 0.049219
#*# 	-0.047656, -0.052344, -0.051563, -0.032813, -0.092969, -0.057031, -0.035938, -0.048438, -0.078125, -0.007031, -0.027344, 0.016406, 0.043750, 0.009375, 0.032031
#*# 	-0.055469, -0.021875, -0.039063, -0.023438, -0.049219, -0.036719, -0.021094, -0.065625, -0.014844, 0.015625, -0.021094, -0.002344, 0.008594, 0.010937, 0.036719
#*# 	-0.049219, -0.031250, -0.042188, -0.040625, -0.037500, -0.042188, -0.029688, -0.057031, -0.008594, -0.003125, 0.002344, -0.019531, -0.017188, -0.000000, 0.044531
#*# tension = 0.2
#*# min_x = 25.0
#*# algo = bicubic
#*# y_count = 15
#*# mesh_y_pps = 2
#*# min_y = 35.0
#*# x_count = 15
#*# max_y = 219.94
#*# mesh_x_pps = 2
#*# max_x = 224.92
#*#
#*# [stepper_z]
#*# position_endstop = 4.388
#*#
#*# [bed_mesh MANUAL_3X3]
#*# version = 1
#*# points =
#*# 	-0.015625, 0.075000, 0.153125
#*# 	0.043750, 0.000000, -0.021875
#*# 	-0.128125, -0.034375, -0.056250
#*# tension = 0.2
#*# mesh_x_pps = 2
#*# algo = bicubic
#*# min_x = 25.0
#*# min_y = 35.0
#*# y_count = 3
#*# mesh_y_pps = 2
#*# x_count = 3
#*# max_x = 225.0
#*# max_y = 220.0
